{% extends 'layouts/blank.html' %}

{% block content %}
<div class="max-w-lg mx-auto py-20">
    <h1 class="text-2xl font-bold mb-6">积分充值</h1>
    <form id="recharge-form">
        {% csrf_token %}
        <div class="mb-4">
            <label for="amount" class="block text-sm font-medium text-gray-700">充值金额（元）</label>
            <input type="number" id="amount" name="amount" min="1" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
        </div>
        <p id="points-preview" class="text-gray-600">可获得积分：0</p>
        <div class="mb-4">
            <label for="payment_method" class="block text-sm font-medium text-gray-700">支付方式</label>
            <select id="payment_method" name="payment_method" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                <option value="wechat">微信支付</option>
                <option value="alipay">支付宝</option>
                <option value="unionpay">银联支付</option>
            </select>
        </div>
        <button type="submit" class="btn btn-primary">提交订单</button>
    </form>
</div>

<script>
    // 实时更新积分预览
    document.getElementById('amount').addEventListener('input', function () {
        const amount = parseInt(this.value) || 0;
        const points = amount * 10; // 假设 1 元兑换 10 积分
        document.getElementById('points-preview').textContent = `可获得积分：${points}`;
    });

    // 提交表单
    document.getElementById('recharge-form').addEventListener('submit', function (event) {
        event.preventDefault();

        const formData = new FormData(this);
        const requestData = {
            amount: formData.get('amount'),
            payment_method: formData.get('payment_method'),
        };

        fetch("{% url 'a_order:create_recharge_order' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData),
        })
        .then(response => response.json())
        .then(data => {
            if (data.payment_url) {
                window.location.href = data.payment_url;
            } else {
                alert('创建支付订单失败，请重试。');
            }
        })
        .catch(error => {
            console.error('Error creating payment order:', error);
            alert('创建支付订单失败，请稍后重试。');
        });
    });
</script>
{% endblock %}